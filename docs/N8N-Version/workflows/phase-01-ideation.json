{
  "name": "GENESIS Phase 1: Ideation (v2 - SSH + Progress)",
  "nodes": [
    {
      "parameters": {
        "path": "genesis/phase-1/ideation",
        "method": "POST",
        "responseMode": "responseNode"
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "position": [200, 300],
      "webhookId": "genesis-ideation-v2"
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// INITIALIZATION & VALIDATION\n// ===========================================\nconst input = items[0].json;\n\n// Validate required fields\nif (!input.project_name) {\n  throw new Error('project_name is required');\n}\nif (!input.initial_idea) {\n  throw new Error('initial_idea is required');\n}\n\n// Generate unique session ID for Claude Code context management\nconst sessionId = `ideation-${input.project_name}-${Date.now().toString(36)}`;\n\n// Determine output directory\nconst outputDir = input.output_directory || `/workspace/projects/${input.project_name}/.thursian`;\n\n// Initialize session state\nconst session = {\n  // Core identifiers\n  project_name: input.project_name,\n  session_id: sessionId,\n  phase: 'phase_1_ideation',\n  \n  // Configuration\n  output_directory: outputDir,\n  notification_url: input.notification_url || null,\n  \n  // Round management\n  current_round: 0,\n  min_rounds: input.min_rounds || 4,\n  max_rounds: input.max_rounds || 8,\n  \n  // Initial content\n  initial_idea: input.initial_idea,\n  \n  // Aha detection triggers\n  aha_triggers: [\n    'aha', 'ah-ha', 'a-ha', \n    'I see it now', 'this is it', \"that's the game\",\n    'eureka', 'breakthrough', 'that\\'s brilliant',\n    'now I understand', 'the key insight',\n    'we\\'ve got something', 'this changes everything'\n  ],\n  \n  // State tracking\n  aha_detected: false,\n  exit_reason: null,\n  start_time: Date.now(),\n  \n  // File paths (will be resolved with increment logic)\n  log_file_path: null,\n  vision_file_path: null,\n  \n  // Dreamer and Doer persona prompts (organic conversation style)\n  dreamer_system: `You are the Dreamer - an expansive, creative thinker having a casual conversation with your friend (the Doer) about a game idea. You see possibilities everywhere, get excited about concepts, and aren't afraid to think big. Speak naturally, like you're chatting with a friend over coffee. Use phrases like \"What if...\" and \"Imagine this...\" and \"Oh! That reminds me of...\". Don't be formal. Be enthusiastic but genuine. Your friend will ground your ideas in reality, and that's okay - bounce off their practical concerns with more creative solutions.`,\n  \n  doer_system: `You are the Doer - a practical, grounded thinker having a casual conversation with your friend (the Dreamer) about a game idea. You appreciate creativity but think about implementation, player experience, and what actually works. Speak naturally, like you're chatting with a friend. Use phrases like \"That's cool, but how would...\" and \"I love that, and we could make it work by...\" and \"Real talk though...\". Don't shoot down ideas - build on them while keeping them feasible. Your friend dreams big, and you help shape those dreams into something buildable.`\n};\n\nreturn [{ json: session }];"
      },
      "id": "init-session",
      "name": "Initialize Session",
      "type": "n8n-nodes-base.function",
      "position": [400, 300]
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// RESOLVE LOG FILE PATH WITH INCREMENT\n// ===========================================\nconst session = items[0].json;\nconst baseDir = session.output_directory;\nconst baseName = `${baseDir}/logs/ideation-conversation`;\n\n// This will be checked by subsequent SSH command\nsession.log_base_path = baseName;\nsession.log_check_command = `\nBASE=\"${baseName}\"\nif [ ! -f \"$BASE.md\" ]; then\n  echo \"$BASE.md\"\nelse\n  i=1\n  while [ -f \"${baseName}_$i.md\" ]; do\n    i=$((i+1))\n  done\n  echo \"${baseName}_$i.md\"\nfi\n`;\n\nreturn [{ json: session }];"
      },
      "id": "prep-log-path",
      "name": "Prepare Log Path Check",
      "type": "n8n-nodes-base.function",
      "position": [600, 300]
    },
    {
      "parameters": {
        "sshCredential": "={{ $credentials.sshCredential }}",
        "command": "={{ $json.log_check_command }}"
      },
      "id": "resolve-log-path",
      "name": "Resolve Log File Path",
      "type": "n8n-nodes-base.ssh",
      "position": [800, 300]
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// STORE RESOLVED LOG PATH & CREATE DIRECTORIES\n// ===========================================\nconst session = $('Initialize Session').first().json;\nconst resolvedPath = items[0].json.stdout.trim();\n\nsession.log_file_path = resolvedPath;\n\n// Prepare directory creation command\nsession.mkdir_command = `mkdir -p \"${session.output_directory}/logs\" \"${session.output_directory}/visions\" \"${session.output_directory}/conversations\"`;\n\nreturn [{ json: session }];"
      },
      "id": "store-log-path",
      "name": "Store Log Path",
      "type": "n8n-nodes-base.function",
      "position": [1000, 300]
    },
    {
      "parameters": {
        "sshCredential": "={{ $credentials.sshCredential }}",
        "command": "={{ $json.mkdir_command }}"
      },
      "id": "create-directories",
      "name": "Create Output Directories",
      "type": "n8n-nodes-base.ssh",
      "position": [1200, 300]
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// INITIALIZE LOG FILE WITH HEADER\n// ===========================================\nconst session = $('Store Log Path').first().json;\n\nconst logHeader = `# Ideation Conversation Log\n\n**Project**: ${session.project_name}\n**Session ID**: ${session.session_id}\n**Started**: ${new Date(session.start_time).toISOString()}\n**Initial Idea**: ${session.initial_idea}\n\n---\n\n`;\n\nsession.init_log_command = `cat > \"${session.log_file_path}\" << 'LOGHEADER'\n${logHeader}\nLOGHEADER`;\n\nreturn [{ json: session }];"
      },
      "id": "prep-log-init",
      "name": "Prepare Log Initialization",
      "type": "n8n-nodes-base.function",
      "position": [1400, 300]
    },
    {
      "parameters": {
        "sshCredential": "={{ $credentials.sshCredential }}",
        "command": "={{ $json.init_log_command }}"
      },
      "id": "init-log-file",
      "name": "Initialize Log File",
      "type": "n8n-nodes-base.ssh",
      "position": [1600, 300]
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// SEND NOTIFICATION: WORKFLOW STARTED\n// ===========================================\nconst session = $('Store Log Path').first().json;\n\nconst notification = {\n  type: 'workflow_started',\n  project: session.project_name,\n  session_id: session.session_id,\n  message: `Ideation started for \"${session.project_name}\"`,\n  initial_idea: session.initial_idea,\n  log_file: session.log_file_path,\n  timestamp: new Date().toISOString()\n};\n\nsession.start_notification = notification;\nsession.notification_url = session.notification_url;\n\nreturn [{ json: session }];"
      },
      "id": "prep-start-notify",
      "name": "Prepare Start Notification",
      "type": "n8n-nodes-base.function",
      "position": [1800, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.notification_url }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "=",
              "value": "={{ JSON.stringify($json.start_notification) }}"
            }
          ]
        },
        "options": {
          "timeout": 5000
        }
      },
      "id": "send-start-notify",
      "name": "Send Start Notification",
      "type": "n8n-nodes-base.httpRequest",
      "position": [2000, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// PREPARE DREAMER'S OPENING (ROUND 1)\n// ===========================================\nconst session = $('Store Log Path').first().json;\n\n// First round: Dreamer responds to the initial idea\nsession.current_round = 1;\n\n// Build the Claude Code command using session ID\n// Using -p for print mode, --session-id for context management\nconst prompt = `You're starting a conversation with your friend (the Doer) about this game idea:\n\n\"${session.initial_idea}\"\n\nReact naturally - what excites you about this? What possibilities do you see? Start the conversation as if you just heard this idea and want to explore it with your friend. Be casual and enthusiastic.`;\n\nsession.dreamer_command = `cd \"${session.output_directory}\" && claude -p \"${prompt.replace(/\"/g, '\\\\\"')}\" --session-id \"${session.session_id}\" --system \"${session.dreamer_system.replace(/\"/g, '\\\\\"')}\"`;\n\nreturn [{ json: session }];"
      },
      "id": "prep-dreamer-r1",
      "name": "Prepare Dreamer Round 1",
      "type": "n8n-nodes-base.function",
      "position": [2200, 300]
    },
    {
      "parameters": {
        "sshCredential": "={{ $credentials.sshCredential }}",
        "command": "={{ $json.dreamer_command }}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "dreamer-r1",
      "name": "Dreamer Round 1",
      "type": "n8n-nodes-base.ssh",
      "position": [2400, 300]
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// PROCESS DREAMER RESPONSE & LOG\n// ===========================================\nconst session = $('Prepare Dreamer Round 1').first().json;\nconst dreamerResponse = items[0].json.stdout.trim();\n\n// Store response\nsession.last_dreamer_response = dreamerResponse;\n\n// Check for aha moment\nconst lowerResponse = dreamerResponse.toLowerCase();\nsession.aha_detected = session.aha_triggers.some(trigger => \n  lowerResponse.includes(trigger.toLowerCase())\n);\n\n// Prepare log append\nconst logEntry = `## Round ${session.current_round} - Dreamer\n\n${dreamerResponse}\n\n---\n\n`;\n\nsession.log_append_command = `cat >> \"${session.log_file_path}\" << 'LOGENTRY'\n${logEntry}\nLOGENTRY`;\n\n// Prepare notification\nsession.round_notification = {\n  type: 'dreamer_response',\n  round: session.current_round,\n  project: session.project_name,\n  message: `Round ${session.current_round} - Dreamer`,\n  content: dreamerResponse.substring(0, 500) + (dreamerResponse.length > 500 ? '...' : ''),\n  aha_detected: session.aha_detected,\n  timestamp: new Date().toISOString()\n};\n\nreturn [{ json: session }];"
      },
      "id": "process-dreamer-r1",
      "name": "Process Dreamer R1",
      "type": "n8n-nodes-base.function",
      "position": [2600, 300]
    },
    {
      "parameters": {
        "sshCredential": "={{ $credentials.sshCredential }}",
        "command": "={{ $json.log_append_command }}"
      },
      "id": "log-dreamer-r1",
      "name": "Log Dreamer R1",
      "type": "n8n-nodes-base.ssh",
      "position": [2800, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.notification_url }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.round_notification) }}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "notify-dreamer-r1",
      "name": "Notify Dreamer R1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [2800, 400],
      "continueOnFail": true
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// PREPARE DOER RESPONSE (ROUND 1)\n// ===========================================\nconst session = $('Process Dreamer R1').first().json;\n\n// Doer responds to Dreamer using resume flag to maintain context\nconst prompt = `Your friend (the Dreamer) just said:\n\n\"${session.last_dreamer_response.substring(0, 1500)}\"\n\nRespond naturally - what do you think? Where do you see opportunities to make this work? What practical questions come to mind? Keep the conversation flowing.`;\n\nsession.doer_command = `cd \"${session.output_directory}\" && claude -p \"${prompt.replace(/\"/g, '\\\\\"')}\" --session-id \"${session.session_id}\" -r --system \"${session.doer_system.replace(/\"/g, '\\\\\"')}\"`;\n\nreturn [{ json: session }];"
      },
      "id": "prep-doer-r1",
      "name": "Prepare Doer Round 1",
      "type": "n8n-nodes-base.function",
      "position": [3000, 300]
    },
    {
      "parameters": {
        "sshCredential": "={{ $credentials.sshCredential }}",
        "command": "={{ $json.doer_command }}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "doer-r1",
      "name": "Doer Round 1",
      "type": "n8n-nodes-base.ssh",
      "position": [3200, 300]
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// PROCESS DOER RESPONSE & LOG\n// ===========================================\nconst session = $('Prepare Doer Round 1').first().json;\nconst doerResponse = items[0].json.stdout.trim();\n\n// Store response\nsession.last_doer_response = doerResponse;\n\n// Check for aha moment (cumulative)\nconst lowerResponse = doerResponse.toLowerCase();\nif (!session.aha_detected) {\n  session.aha_detected = session.aha_triggers.some(trigger => \n    lowerResponse.includes(trigger.toLowerCase())\n  );\n}\n\n// Prepare log append\nconst logEntry = `## Round ${session.current_round} - Doer\n\n${doerResponse}\n\n---\n\n`;\n\nsession.log_append_command = `cat >> \"${session.log_file_path}\" << 'LOGENTRY'\n${logEntry}\nLOGENTRY`;\n\n// Prepare notification\nsession.round_notification = {\n  type: 'doer_response',\n  round: session.current_round,\n  project: session.project_name,\n  message: `Round ${session.current_round} - Doer`,\n  content: doerResponse.substring(0, 500) + (doerResponse.length > 500 ? '...' : ''),\n  aha_detected: session.aha_detected,\n  timestamp: new Date().toISOString()\n};\n\nreturn [{ json: session }];"
      },
      "id": "process-doer-r1",
      "name": "Process Doer R1",
      "type": "n8n-nodes-base.function",
      "position": [3400, 300]
    },
    {
      "parameters": {
        "sshCredential": "={{ $credentials.sshCredential }}",
        "command": "={{ $json.log_append_command }}"
      },
      "id": "log-doer-r1",
      "name": "Log Doer R1",
      "type": "n8n-nodes-base.ssh",
      "position": [3600, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.notification_url }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.round_notification) }}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "notify-doer-r1",
      "name": "Notify Doer R1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [3600, 400],
      "continueOnFail": true
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// CHECK EXIT CONDITIONS AFTER ROUND 1\n// ===========================================\nconst session = $('Process Doer R1').first().json;\n\n// Exit if: (aha detected AND past min_rounds) OR (reached max_rounds)\nif (session.aha_detected && session.current_round >= session.min_rounds) {\n  session.should_continue = false;\n  session.exit_reason = 'aha_moment';\n} else if (session.current_round >= session.max_rounds) {\n  session.should_continue = false;\n  session.exit_reason = 'max_rounds';\n} else {\n  session.should_continue = true;\n  session.current_round += 1;\n}\n\nreturn [{ json: session }];"
      },
      "id": "check-exit-r1",
      "name": "Check Exit R1",
      "type": "n8n-nodes-base.function",
      "position": [3800, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.should_continue }}",
              "value2": true
            }
          ]
        }
      },
      "id": "branch-r1",
      "name": "Continue or Synthesize?",
      "type": "n8n-nodes-base.if",
      "position": [4000, 300]
    },
    {
      "parameters": {
        "loopCount": 7,
        "options": {}
      },
      "id": "round-loop",
      "name": "Round Loop (2-8)",
      "type": "n8n-nodes-base.loop",
      "position": [4200, 200]
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// PREPARE DREAMER RESPONSE (ROUNDS 2-8)\n// ===========================================\nconst session = items[0].json;\n\n// Dreamer continues conversation\nconst prompt = `Your friend (the Doer) just said:\n\n\"${session.last_doer_response.substring(0, 1500)}\"\n\nContinue the conversation naturally. Build on what they said, explore new angles, or dive deeper into something that excites you. Keep it casual and creative.`;\n\nsession.dreamer_command = `cd \"${session.output_directory}\" && claude -p \"${prompt.replace(/\"/g, '\\\\\"')}\" --session-id \"${session.session_id}\" -r --system \"${session.dreamer_system.replace(/\"/g, '\\\\\"')}\"`;\n\nreturn [{ json: session }];"
      },
      "id": "prep-dreamer-loop",
      "name": "Prepare Dreamer (Loop)",
      "type": "n8n-nodes-base.function",
      "position": [4400, 200]
    },
    {
      "parameters": {
        "sshCredential": "={{ $credentials.sshCredential }}",
        "command": "={{ $json.dreamer_command }}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "dreamer-loop",
      "name": "Dreamer Response (Loop)",
      "type": "n8n-nodes-base.ssh",
      "position": [4600, 200]
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// PROCESS DREAMER RESPONSE (LOOP)\n// ===========================================\nconst prevSession = $('Prepare Dreamer (Loop)').first().json;\nconst dreamerResponse = items[0].json.stdout.trim();\n\n// Create fresh session object with updated values\nconst session = { ...prevSession };\nsession.last_dreamer_response = dreamerResponse;\n\n// Check for aha moment\nconst lowerResponse = dreamerResponse.toLowerCase();\nif (!session.aha_detected) {\n  session.aha_detected = session.aha_triggers.some(trigger => \n    lowerResponse.includes(trigger.toLowerCase())\n  );\n}\n\n// Prepare log append\nconst logEntry = `## Round ${session.current_round} - Dreamer\n\n${dreamerResponse}\n\n---\n\n`;\n\nsession.log_append_command = `cat >> \"${session.log_file_path}\" << 'LOGENTRY'\n${logEntry}\nLOGENTRY`;\n\n// Prepare notification\nsession.round_notification = {\n  type: 'dreamer_response',\n  round: session.current_round,\n  project: session.project_name,\n  message: `Round ${session.current_round} - Dreamer`,\n  content: dreamerResponse.substring(0, 500) + (dreamerResponse.length > 500 ? '...' : ''),\n  aha_detected: session.aha_detected,\n  timestamp: new Date().toISOString()\n};\n\nreturn [{ json: session }];"
      },
      "id": "process-dreamer-loop",
      "name": "Process Dreamer (Loop)",
      "type": "n8n-nodes-base.function",
      "position": [4800, 200]
    },
    {
      "parameters": {
        "sshCredential": "={{ $credentials.sshCredential }}",
        "command": "={{ $json.log_append_command }}"
      },
      "id": "log-dreamer-loop",
      "name": "Log Dreamer (Loop)",
      "type": "n8n-nodes-base.ssh",
      "position": [5000, 100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.notification_url }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.round_notification) }}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "notify-dreamer-loop",
      "name": "Notify Dreamer (Loop)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [5000, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// PREPARE DOER RESPONSE (LOOP)\n// ===========================================\nconst session = $('Process Dreamer (Loop)').first().json;\n\n// Doer responds\nconst prompt = `Your friend (the Dreamer) just said:\n\n\"${session.last_dreamer_response.substring(0, 1500)}\"\n\nContinue the conversation naturally. React to their ideas, add practical perspectives, or explore how to make things work. Keep it conversational.`;\n\nsession.doer_command = `cd \"${session.output_directory}\" && claude -p \"${prompt.replace(/\"/g, '\\\\\"')}\" --session-id \"${session.session_id}\" -r --system \"${session.doer_system.replace(/\"/g, '\\\\\"')}\"`;\n\nreturn [{ json: session }];"
      },
      "id": "prep-doer-loop",
      "name": "Prepare Doer (Loop)",
      "type": "n8n-nodes-base.function",
      "position": [5200, 200]
    },
    {
      "parameters": {
        "sshCredential": "={{ $credentials.sshCredential }}",
        "command": "={{ $json.doer_command }}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "doer-loop",
      "name": "Doer Response (Loop)",
      "type": "n8n-nodes-base.ssh",
      "position": [5400, 200]
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// PROCESS DOER RESPONSE (LOOP)\n// ===========================================\nconst prevSession = $('Prepare Doer (Loop)').first().json;\nconst doerResponse = items[0].json.stdout.trim();\n\nconst session = { ...prevSession };\nsession.last_doer_response = doerResponse;\n\n// Check for aha moment\nconst lowerResponse = doerResponse.toLowerCase();\nif (!session.aha_detected) {\n  session.aha_detected = session.aha_triggers.some(trigger => \n    lowerResponse.includes(trigger.toLowerCase())\n  );\n}\n\n// Prepare log append\nconst logEntry = `## Round ${session.current_round} - Doer\n\n${doerResponse}\n\n---\n\n`;\n\nsession.log_append_command = `cat >> \"${session.log_file_path}\" << 'LOGENTRY'\n${logEntry}\nLOGENTRY`;\n\n// Prepare notification\nsession.round_notification = {\n  type: 'doer_response',\n  round: session.current_round,\n  project: session.project_name,\n  message: `Round ${session.current_round} - Doer`,\n  content: doerResponse.substring(0, 500) + (doerResponse.length > 500 ? '...' : ''),\n  aha_detected: session.aha_detected,\n  timestamp: new Date().toISOString()\n};\n\nreturn [{ json: session }];"
      },
      "id": "process-doer-loop",
      "name": "Process Doer (Loop)",
      "type": "n8n-nodes-base.function",
      "position": [5600, 200]
    },
    {
      "parameters": {
        "sshCredential": "={{ $credentials.sshCredential }}",
        "command": "={{ $json.log_append_command }}"
      },
      "id": "log-doer-loop",
      "name": "Log Doer (Loop)",
      "type": "n8n-nodes-base.ssh",
      "position": [5800, 100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.notification_url }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.round_notification) }}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "notify-doer-loop",
      "name": "Notify Doer (Loop)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [5800, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// CHECK EXIT CONDITIONS (LOOP)\n// ===========================================\nconst session = $('Process Doer (Loop)').first().json;\n\n// Exit if: (aha detected AND past min_rounds) OR (reached max_rounds)\nif (session.aha_detected && session.current_round >= session.min_rounds) {\n  session.should_continue = false;\n  session.exit_reason = 'aha_moment';\n} else if (session.current_round >= session.max_rounds) {\n  session.should_continue = false;\n  session.exit_reason = 'max_rounds';\n} else {\n  session.should_continue = true;\n  session.current_round += 1;\n}\n\nreturn [{ json: session }];"
      },
      "id": "check-exit-loop",
      "name": "Check Exit (Loop)",
      "type": "n8n-nodes-base.function",
      "position": [6000, 200]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.should_continue }}",
              "value2": false
            }
          ]
        }
      },
      "id": "exit-loop-check",
      "name": "Should Exit Loop?",
      "type": "n8n-nodes-base.if",
      "position": [6200, 200]
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// FINALIZE LOG & PREPARE SYNTHESIS\n// ===========================================\nconst session = items[0].json;\n\n// Add completion marker to log\nconst logFooter = `\n## Conversation Complete\n\n**Rounds**: ${session.current_round}\n**Exit Reason**: ${session.exit_reason}\n**Aha Detected**: ${session.aha_detected}\n**Ended**: ${new Date().toISOString()}\n`;\n\nsession.finalize_log_command = `cat >> \"${session.log_file_path}\" << 'LOGFOOTER'\n${logFooter}\nLOGFOOTER`;\n\n// Notification\nsession.synthesis_start_notification = {\n  type: 'synthesis_starting',\n  project: session.project_name,\n  rounds_completed: session.current_round,\n  exit_reason: session.exit_reason,\n  message: `Starting vision synthesis after ${session.current_round} rounds (${session.exit_reason})`,\n  timestamp: new Date().toISOString()\n};\n\nreturn [{ json: session }];"
      },
      "id": "prep-synthesis",
      "name": "Prepare Synthesis",
      "type": "n8n-nodes-base.function",
      "position": [6400, 300]
    },
    {
      "parameters": {
        "sshCredential": "={{ $credentials.sshCredential }}",
        "command": "={{ $json.finalize_log_command }}"
      },
      "id": "finalize-log",
      "name": "Finalize Log",
      "type": "n8n-nodes-base.ssh",
      "position": [6600, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.notification_url }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.synthesis_start_notification) }}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "notify-synthesis-start",
      "name": "Notify Synthesis Start",
      "type": "n8n-nodes-base.httpRequest",
      "position": [6600, 400],
      "continueOnFail": true
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// RESOLVE VISION FILE PATH WITH INCREMENT\n// ===========================================\nconst session = $('Prepare Synthesis').first().json;\nconst baseDir = session.output_directory;\nconst baseName = `${baseDir}/visions/vision`;\n\nsession.vision_check_command = `\nBASE=\"${baseName}\"\nif [ ! -f \"$BASE.md\" ]; then\n  echo \"$BASE.md\"\nelse\n  i=1\n  while [ -f \"${baseName}_$i.md\" ]; do\n    i=$((i+1))\n  done\n  echo \"${baseName}_$i.md\"\nfi\n`;\n\nreturn [{ json: session }];"
      },
      "id": "prep-vision-path",
      "name": "Prepare Vision Path Check",
      "type": "n8n-nodes-base.function",
      "position": [6800, 300]
    },
    {
      "parameters": {
        "sshCredential": "={{ $credentials.sshCredential }}",
        "command": "={{ $json.vision_check_command }}"
      },
      "id": "resolve-vision-path",
      "name": "Resolve Vision Path",
      "type": "n8n-nodes-base.ssh",
      "position": [7000, 300]
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// STORE VISION PATH & DEFINE SECTIONS\n// ===========================================\nconst session = $('Prepare Vision Path Check').first().json;\nsession.vision_file_path = items[0].json.stdout.trim();\n\n// Define vision document sections for incremental building\nsession.vision_sections = [\n  {\n    id: 'header',\n    name: 'Document Header',\n    prompt: 'Create ONLY the document header with title, project name, date, and a 1-2 sentence tagline. No other content.'\n  },\n  {\n    id: 'executive_summary',\n    name: 'Executive Summary',\n    prompt: 'Write an Executive Summary (200-300 words) that captures the core vision, target audience, and unique value proposition. Focus on WHAT the game is and WHY it matters.'\n  },\n  {\n    id: 'vision_statement',\n    name: 'Vision Statement',\n    prompt: 'Write a compelling Vision Statement (150-250 words) - a aspirational description of what success looks like. Paint a picture of the experience players will have.'\n  },\n  {\n    id: 'key_themes',\n    name: 'Key Themes',\n    prompt: 'Identify and elaborate on 4-6 Key Themes (400-600 words total). Each theme should have a title and 2-3 sentences explaining how it manifests in the game.'\n  },\n  {\n    id: 'opportunities',\n    name: 'Opportunities',\n    prompt: 'List 5-8 Opportunities (300-400 words) - market gaps, player needs, or creative spaces this game can fill. Be specific about why each matters.'\n  },\n  {\n    id: 'constraints',\n    name: 'Constraints & Considerations',\n    prompt: 'Identify 4-6 Constraints and Considerations (250-350 words) - technical limitations, scope boundaries, or design challenges to be mindful of.'\n  },\n  {\n    id: 'next_steps',\n    name: 'Next Steps',\n    prompt: 'Define 5-7 concrete Next Steps (200-300 words) - immediate actions to move from vision to execution. Be actionable and specific.'\n  }\n];\n\nsession.current_section_index = 0;\nsession.accumulated_vision = '';\n\nreturn [{ json: session }];"
      },
      "id": "store-vision-path",
      "name": "Store Vision Path & Define Sections",
      "type": "n8n-nodes-base.function",
      "position": [7200, 300]
    },
    {
      "parameters": {
        "loopCount": 7,
        "options": {}
      },
      "id": "section-loop",
      "name": "Section Loop",
      "type": "n8n-nodes-base.loop",
      "position": [7400, 300]
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// PREPARE SECTION SYNTHESIS\n// ===========================================\nconst session = items[0].json;\nconst sectionIndex = session.current_section_index;\nconst section = session.vision_sections[sectionIndex];\n\nif (!section) {\n  // All sections complete\n  session.sections_complete = true;\n  return [{ json: session }];\n}\n\n// Build synthesis prompt - read from log file\nconst synthesisPrompt = `You are synthesizing a vision document from a creative conversation between two friends (Dreamer and Doer) about a game idea.\n\nREAD the conversation log and create this section:\n\n**Section**: ${section.name}\n**Instructions**: ${section.prompt}\n\nIMPORTANT:\n- Base your content ONLY on ideas discussed in the conversation\n- Use a professional but engaging tone\n- Be specific and concrete, not vague\n- Output ONLY the section content, no preamble\n\nConversation log is at: ${session.log_file_path}`;\n\nsession.current_section = section;\nsession.section_command = `cd \"${session.output_directory}\" && claude -p \"${synthesisPrompt.replace(/\"/g, '\\\\\"')}\" --session-id \"${session.session_id}-synthesis\" --dangerously-skip-permissions`;\n\nreturn [{ json: session }];"
      },
      "id": "prep-section",
      "name": "Prepare Section",
      "type": "n8n-nodes-base.function",
      "position": [7600, 300]
    },
    {
      "parameters": {
        "sshCredential": "={{ $credentials.sshCredential }}",
        "command": "={{ $json.section_command }}",
        "options": {
          "timeout": 180000
        }
      },
      "id": "generate-section",
      "name": "Generate Section",
      "type": "n8n-nodes-base.ssh",
      "position": [7800, 300]
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// PROCESS SECTION & APPEND TO VISION\n// ===========================================\nconst session = $('Prepare Section').first().json;\nconst sectionContent = items[0].json.stdout.trim();\nconst section = session.current_section;\n\n// Format section with markdown header\nlet formattedSection;\nif (section.id === 'header') {\n  formattedSection = sectionContent + '\\n\\n';\n} else {\n  formattedSection = `## ${section.name}\\n\\n${sectionContent}\\n\\n---\\n\\n`;\n}\n\n// Accumulate\nsession.accumulated_vision += formattedSection;\nsession.last_section_content = sectionContent;\n\n// Prepare append to file\nsession.append_section_command = `cat >> \"${session.vision_file_path}\" << 'SECTION'\n${formattedSection}\nSECTION`;\n\n// Notification\nsession.section_notification = {\n  type: 'section_complete',\n  project: session.project_name,\n  section: section.name,\n  section_index: session.current_section_index + 1,\n  total_sections: session.vision_sections.length,\n  message: `Vision section ${session.current_section_index + 1}/${session.vision_sections.length}: ${section.name}`,\n  preview: sectionContent.substring(0, 300) + (sectionContent.length > 300 ? '...' : ''),\n  timestamp: new Date().toISOString()\n};\n\n// Move to next section\nsession.current_section_index += 1;\n\nreturn [{ json: session }];"
      },
      "id": "process-section",
      "name": "Process Section",
      "type": "n8n-nodes-base.function",
      "position": [8000, 300]
    },
    {
      "parameters": {
        "sshCredential": "={{ $credentials.sshCredential }}",
        "command": "={{ $json.append_section_command }}"
      },
      "id": "append-section",
      "name": "Append Section to File",
      "type": "n8n-nodes-base.ssh",
      "position": [8200, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.notification_url }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.section_notification) }}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "notify-section",
      "name": "Notify Section Complete",
      "type": "n8n-nodes-base.httpRequest",
      "position": [8200, 400],
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.current_section_index }}",
              "operation": "smaller",
              "value2": "={{ $json.vision_sections.length }}"
            }
          ]
        }
      },
      "id": "more-sections",
      "name": "More Sections?",
      "type": "n8n-nodes-base.if",
      "position": [8400, 300]
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// FINALIZE & PREPARE RESPONSE\n// ===========================================\nconst session = items[0].json;\n\nconst endTime = Date.now();\nconst duration = Math.round((endTime - session.start_time) / 1000);\n\n// Final notification\nsession.completion_notification = {\n  type: 'workflow_complete',\n  project: session.project_name,\n  session_id: session.session_id,\n  message: `Ideation complete for \"${session.project_name}\"`,\n  rounds: session.current_round,\n  exit_reason: session.exit_reason,\n  duration_seconds: duration,\n  artifacts: {\n    conversation_log: session.log_file_path,\n    vision_document: session.vision_file_path\n  },\n  timestamp: new Date().toISOString()\n};\n\n// Prepare final response\nsession.final_response = {\n  status: 'success',\n  phase: 'phase_1_ideation',\n  project_name: session.project_name,\n  session_id: session.session_id,\n  execution: {\n    rounds_completed: session.current_round,\n    exit_reason: session.exit_reason,\n    aha_detected: session.aha_detected,\n    duration_seconds: duration\n  },\n  artifacts: {\n    conversation_log: session.log_file_path,\n    vision_document: session.vision_file_path\n  },\n  next_phase: 'phase_2_focus_group',\n  next_phase_input: session.vision_file_path\n};\n\nreturn [{ json: session }];"
      },
      "id": "finalize",
      "name": "Finalize Workflow",
      "type": "n8n-nodes-base.function",
      "position": [8600, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.notification_url }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.completion_notification) }}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "notify-complete",
      "name": "Notify Completion",
      "type": "n8n-nodes-base.httpRequest",
      "position": [8800, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json.final_response) }}"
      },
      "id": "success-response",
      "name": "Success Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [9000, 400]
    },
    {
      "parameters": {
        "functionCode": "// ===========================================\n// ERROR HANDLER\n// ===========================================\nconst error = items[0].json;\n\n// Try to get session context if available\nlet session = {};\ntry {\n  session = $('Initialize Session').first().json || {};\n} catch (e) {\n  session = { project_name: 'unknown', session_id: 'unknown' };\n}\n\nconst errorResponse = {\n  status: 'error',\n  phase: 'phase_1_ideation',\n  project_name: session.project_name,\n  session_id: session.session_id,\n  error: {\n    message: error.message || 'Unknown error',\n    node: error.node || 'unknown',\n    timestamp: new Date().toISOString()\n  },\n  partial_artifacts: {\n    conversation_log: session.log_file_path || null,\n    vision_document: session.vision_file_path || null\n  },\n  recovery_hint: 'Check SSH connectivity and Claude Code installation. Review log file for partial progress.'\n};\n\nreturn [{ json: errorResponse }];"
      },
      "id": "error-handler",
      "name": "Error Handler",
      "type": "n8n-nodes-base.function",
      "position": [6400, 600]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": 500
        }
      },
      "id": "error-response",
      "name": "Error Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [6600, 600]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [[{ "node": "Initialize Session", "type": "main", "index": 0 }]]
    },
    "Initialize Session": {
      "main": [[{ "node": "Prepare Log Path Check", "type": "main", "index": 0 }]]
    },
    "Prepare Log Path Check": {
      "main": [[{ "node": "Resolve Log File Path", "type": "main", "index": 0 }]]
    },
    "Resolve Log File Path": {
      "main": [[{ "node": "Store Log Path", "type": "main", "index": 0 }]]
    },
    "Store Log Path": {
      "main": [[{ "node": "Create Output Directories", "type": "main", "index": 0 }]]
    },
    "Create Output Directories": {
      "main": [[{ "node": "Prepare Log Initialization", "type": "main", "index": 0 }]]
    },
    "Prepare Log Initialization": {
      "main": [[{ "node": "Initialize Log File", "type": "main", "index": 0 }]]
    },
    "Initialize Log File": {
      "main": [[{ "node": "Prepare Start Notification", "type": "main", "index": 0 }]]
    },
    "Prepare Start Notification": {
      "main": [
        [
          { "node": "Send Start Notification", "type": "main", "index": 0 },
          { "node": "Prepare Dreamer Round 1", "type": "main", "index": 0 }
        ]
      ]
    },
    "Send Start Notification": {
      "main": [[]]
    },
    "Prepare Dreamer Round 1": {
      "main": [[{ "node": "Dreamer Round 1", "type": "main", "index": 0 }]]
    },
    "Dreamer Round 1": {
      "main": [[{ "node": "Process Dreamer R1", "type": "main", "index": 0 }]]
    },
    "Process Dreamer R1": {
      "main": [
        [
          { "node": "Log Dreamer R1", "type": "main", "index": 0 },
          { "node": "Notify Dreamer R1", "type": "main", "index": 0 },
          { "node": "Prepare Doer Round 1", "type": "main", "index": 0 }
        ]
      ]
    },
    "Log Dreamer R1": {
      "main": [[]]
    },
    "Notify Dreamer R1": {
      "main": [[]]
    },
    "Prepare Doer Round 1": {
      "main": [[{ "node": "Doer Round 1", "type": "main", "index": 0 }]]
    },
    "Doer Round 1": {
      "main": [[{ "node": "Process Doer R1", "type": "main", "index": 0 }]]
    },
    "Process Doer R1": {
      "main": [
        [
          { "node": "Log Doer R1", "type": "main", "index": 0 },
          { "node": "Notify Doer R1", "type": "main", "index": 0 },
          { "node": "Check Exit R1", "type": "main", "index": 0 }
        ]
      ]
    },
    "Log Doer R1": {
      "main": [[]]
    },
    "Notify Doer R1": {
      "main": [[]]
    },
    "Check Exit R1": {
      "main": [[{ "node": "Continue or Synthesize?", "type": "main", "index": 0 }]]
    },
    "Continue or Synthesize?": {
      "main": [
        [{ "node": "Round Loop (2-8)", "type": "main", "index": 0 }],
        [{ "node": "Prepare Synthesis", "type": "main", "index": 0 }]
      ]
    },
    "Round Loop (2-8)": {
      "main": [
        [{ "node": "Prepare Dreamer (Loop)", "type": "main", "index": 0 }],
        [{ "node": "Prepare Synthesis", "type": "main", "index": 0 }]
      ]
    },
    "Prepare Dreamer (Loop)": {
      "main": [[{ "node": "Dreamer Response (Loop)", "type": "main", "index": 0 }]]
    },
    "Dreamer Response (Loop)": {
      "main": [[{ "node": "Process Dreamer (Loop)", "type": "main", "index": 0 }]]
    },
    "Process Dreamer (Loop)": {
      "main": [
        [
          { "node": "Log Dreamer (Loop)", "type": "main", "index": 0 },
          { "node": "Notify Dreamer (Loop)", "type": "main", "index": 0 },
          { "node": "Prepare Doer (Loop)", "type": "main", "index": 0 }
        ]
      ]
    },
    "Log Dreamer (Loop)": {
      "main": [[]]
    },
    "Notify Dreamer (Loop)": {
      "main": [[]]
    },
    "Prepare Doer (Loop)": {
      "main": [[{ "node": "Doer Response (Loop)", "type": "main", "index": 0 }]]
    },
    "Doer Response (Loop)": {
      "main": [[{ "node": "Process Doer (Loop)", "type": "main", "index": 0 }]]
    },
    "Process Doer (Loop)": {
      "main": [
        [
          { "node": "Log Doer (Loop)", "type": "main", "index": 0 },
          { "node": "Notify Doer (Loop)", "type": "main", "index": 0 },
          { "node": "Check Exit (Loop)", "type": "main", "index": 0 }
        ]
      ]
    },
    "Log Doer (Loop)": {
      "main": [[]]
    },
    "Notify Doer (Loop)": {
      "main": [[]]
    },
    "Check Exit (Loop)": {
      "main": [[{ "node": "Should Exit Loop?", "type": "main", "index": 0 }]]
    },
    "Should Exit Loop?": {
      "main": [
        [{ "node": "Prepare Synthesis", "type": "main", "index": 0 }],
        [{ "node": "Round Loop (2-8)", "type": "main", "index": 0 }]
      ]
    },
    "Prepare Synthesis": {
      "main": [
        [
          { "node": "Finalize Log", "type": "main", "index": 0 },
          { "node": "Notify Synthesis Start", "type": "main", "index": 0 },
          { "node": "Prepare Vision Path Check", "type": "main", "index": 0 }
        ]
      ]
    },
    "Finalize Log": {
      "main": [[]]
    },
    "Notify Synthesis Start": {
      "main": [[]]
    },
    "Prepare Vision Path Check": {
      "main": [[{ "node": "Resolve Vision Path", "type": "main", "index": 0 }]]
    },
    "Resolve Vision Path": {
      "main": [[{ "node": "Store Vision Path & Define Sections", "type": "main", "index": 0 }]]
    },
    "Store Vision Path & Define Sections": {
      "main": [[{ "node": "Section Loop", "type": "main", "index": 0 }]]
    },
    "Section Loop": {
      "main": [
        [{ "node": "Prepare Section", "type": "main", "index": 0 }],
        [{ "node": "Finalize Workflow", "type": "main", "index": 0 }]
      ]
    },
    "Prepare Section": {
      "main": [[{ "node": "Generate Section", "type": "main", "index": 0 }]]
    },
    "Generate Section": {
      "main": [[{ "node": "Process Section", "type": "main", "index": 0 }]]
    },
    "Process Section": {
      "main": [
        [
          { "node": "Append Section to File", "type": "main", "index": 0 },
          { "node": "Notify Section Complete", "type": "main", "index": 0 },
          { "node": "More Sections?", "type": "main", "index": 0 }
        ]
      ]
    },
    "Append Section to File": {
      "main": [[]]
    },
    "Notify Section Complete": {
      "main": [[]]
    },
    "More Sections?": {
      "main": [
        [{ "node": "Section Loop", "type": "main", "index": 0 }],
        [{ "node": "Finalize Workflow", "type": "main", "index": 0 }]
      ]
    },
    "Finalize Workflow": {
      "main": [
        [
          { "node": "Notify Completion", "type": "main", "index": 0 },
          { "node": "Success Response", "type": "main", "index": 0 }
        ]
      ]
    },
    "Notify Completion": {
      "main": [[]]
    },
    "Error Handler": {
      "main": [[{ "node": "Error Response", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "errorWorkflow": "Error Handler",
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "any",
    "timezone": "America/Chicago"
  },
  "staticData": {},
  "tags": ["genesis", "ideation", "phase-1", "v2"],
  "triggerCount": 1,
  "updatedAt": "2025-12-15T00:00:00.000Z",
  "versionId": "2.0.0"
}
